# Blog-Family 整合实施任务清单

## 概述
本文档列出将 blog-system 整合到 family-points-bank 的所有实施任务。

## 任务状态
- `[ ]` 未开始
- `[~]` 进行中
- `[x]` 已完成

---

## 阶段 1: 数据库迁移（最高优先级）

### 1.1 备份和准备
- [ ] 1.1.1 备份 family-points-bank Supabase 数据库
- [ ] 1.1.2 记录当前数据库状态（表数量、数据量）
- [ ] 1.1.3 准备回滚方案

### 1.2 执行迁移 SQL
- [ ] 1.2.1 在 Supabase SQL Editor 中打开 `migration.sql`
- [ ] 1.2.2 执行第一部分：扩展 profiles 表
- [ ] 1.2.3 验证 profiles 表字段添加成功
- [ ] 1.2.4 执行第二部分：创建 blog 表
- [ ] 1.2.5 验证所有 7 个表创建成功
- [ ] 1.2.6 执行第三部分：创建索引
- [ ] 1.2.7 执行第四部分：启用 RLS
- [ ] 1.2.8 执行第五部分：创建 RLS 策略
- [ ] 1.2.9 执行第六部分：创建触发器和函数
- [ ] 1.2.10 验证迁移完成消息

### 1.3 Storage 配置
- [ ] 1.3.1 在 Supabase Dashboard 创建 `blog-media` bucket
- [ ] 1.3.2 设置 bucket 为 public
- [ ] 1.3.3 配置文件大小限制为 5MB
- [ ] 1.3.4 配置允许的 MIME 类型
- [ ] 1.3.5 在 SQL Editor 执行 Storage RLS 策略
- [ ] 1.3.6 测试文件上传和访问

### 1.4 验证数据库
- [ ] 1.4.1 检查所有表是否存在
- [ ] 1.4.2 检查所有索引是否创建
- [ ] 1.4.3 检查所有 RLS 策略是否生效
- [ ] 1.4.4 测试插入示例数据
- [ ] 1.4.5 测试 RLS 权限控制
- [ ] 1.4.6 测试自动创建 profile 的触发器

---

## 阶段 2: 环境配置

### 2.1 更新 blog-system 环境变量
- [x] 2.1.1 备份当前 `.env.local` 文件
- [x] 2.1.2 更新 `NEXT_PUBLIC_SUPABASE_URL` 为 family-points-bank 的 URL
- [x] 2.1.3 更新 `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- [x] 2.1.4 更新 `SUPABASE_SERVICE_ROLE_KEY`
- [x] 2.1.5 添加 `NEXT_PUBLIC_FAMILY_BANK_URL`
- [x] 2.1.6 更新 `NEXT_PUBLIC_SITE_URL`
- [x] 2.1.7 更新 `.env.local.example` 模板

### 2.2 验证配置
- [ ] 2.2.1 运行 `verify-env.js` 验证环境变量
- [ ] 2.2.2 测试 Supabase 连接
- [ ] 2.2.3 测试数据库查询
- [ ] 2.2.4 检查控制台是否有错误

---

## 阶段 3: 代码更新

### 3.1 统一认证页面（已完成）
- [x] 3.1.1 创建 `src/app/auth/page.tsx` 统一认证页面
- [x] 3.1.2 实现邮箱+密码登录表单
- [x] 3.1.3 实现登录失败自动尝试注册逻辑
- [x] 3.1.4 实现魔法链接登录
- [x] 3.1.5 实现忘记密码功能
- [x] 3.1.6 使用 family-points-bank 的设计风格
- [x] 3.1.7 移除所有 Google OAuth 相关代码

### 3.2 旧认证页面重定向
- [x] 3.2.1 更新 `src/app/auth/login/page.tsx` 重定向到 `/auth`
- [x] 3.2.2 更新 `src/app/auth/signup/page.tsx` 重定向到 `/auth`
- [ ] 3.2.3 测试重定向功能

### 3.3 Middleware 简化
- [x] 3.3.1 更新 `src/middleware.ts`
- [x] 3.3.2 移除家庭管理员检查逻辑
- [x] 3.3.3 只保留登录状态检查
- [x] 3.3.4 更新重定向目标为 `/auth`
- [ ] 3.3.5 测试 middleware 保护

### 3.4 FamilyBankCTA 组件更新
- [x] 3.4.1 更新 `src/components/FamilyBankCTA.tsx`
- [x] 3.4.2 添加登录状态检测
- [x] 3.4.3 实现动态跳转逻辑（未登录→首页，已登录→dashboard）
- [x] 3.4.4 更新按钮文案
- [ ] 3.4.5 测试两种状态的跳转

### 3.5 Header 组件更新
- [x] 3.5.1 更新 `src/components/layout/Header.tsx`
- [x] 3.5.2 添加"元气银行"导航链接
- [x] 3.5.3 更新用户下拉菜单
- [x] 3.5.4 添加"进入元气银行后台"选项
- [ ] 3.5.5 测试导航链接
- [ ] 3.5.6 测试移动端显示

### 3.6 CustomerSupport 组件更新
- [x] 3.6.1 更新 `src/components/CustomerSupport.tsx`
- [x] 3.6.2 更新常见问题内容
- [x] 3.6.3 添加 family-points-bank 相关问题
- [x] 3.6.4 更新联系方式卡片
- [ ] 3.6.5 测试客服聊天功能

### 3.7 其他页面更新
- [x] 3.7.1 更新首页 `src/app/(frontend)/page.tsx` 的试用按钮（已使用 FamilyBankCTA 组件）
- [x] 3.7.2 更新关于页面 `src/app/(frontend)/about/page.tsx`
- [x] 3.7.3 更新支持页面 `src/app/(frontend)/support/page.tsx`（已使用正确的函数）
- [x] 3.7.4 检查所有页面的 family-points-bank 链接（docs、api、privacy 页面无需更新）
- [x] 3.7.5 更新 Footer 组件 `src/components/layout/Footer.tsx`
- [x] 3.7.6 更新 CustomerSupport 组件中的 FAQ 答案

---

## 阶段 4: 测试

### 4.1 认证功能测试
- [ ] 4.1.1 测试已有用户登录流程
- [ ] 4.1.2 测试新用户注册流程
- [ ] 4.1.3 测试登录失败自动注册
- [ ] 4.1.4 测试密码错误提示
- [ ] 4.1.5 测试魔法链接登录
- [ ] 4.1.6 测试忘记密码功能
- [ ] 4.1.7 验证 OAuth 功能已完全移除

### 4.2 权限测试
- [ ] 4.2.1 测试未登录用户访问 dashboard 被重定向
- [ ] 4.2.2 测试已登录用户可以访问所有页面
- [ ] 4.2.3 测试退出登录功能

### 4.3 功能测试
- [ ] 4.3.1 测试文章创建和发布
- [ ] 4.3.2 测试分类和标签管理
- [ ] 4.3.3 测试评论功能
- [ ] 4.3.4 测试媒体上传
- [ ] 4.3.5 测试所有跳转链接

### 4.4 跨系统测试
- [ ] 4.4.1 在 family-points-bank 注册新用户
- [ ] 4.4.2 使用该用户登录 blog
- [ ] 4.4.3 验证用户信息同步
- [ ] 4.4.4 测试跨系统导航

### 4.5 性能测试
- [ ] 4.5.1 测试首页加载速度
- [ ] 4.5.2 测试文章列表查询性能
- [ ] 4.5.3 测试图片加载速度
- [ ] 4.5.4 检查数据库查询优化

### 4.6 移动端测试
- [ ] 4.6.1 测试移动端导航
- [ ] 4.6.2 测试移动端登录
- [ ] 4.6.3 测试移动端文章阅读
- [ ] 4.6.4 测试移动端客服聊天

---

## 阶段 5: 部署

### 5.1 准备部署
- [ ] 5.1.1 确认所有测试通过
- [ ] 5.1.2 更新部署文档
- [ ] 5.1.3 准备回滚计划
- [ ] 5.1.4 通知相关人员

### 5.2 部署到生产环境
- [ ] 5.2.1 在 Vercel 更新环境变量
- [ ] 5.2.2 部署 blog-system
- [ ] 5.2.3 验证部署成功
- [ ] 5.2.4 检查生产环境日志

### 5.3 域名配置
- [ ] 5.3.1 配置 blog.familybank.chat 域名
- [ ] 5.3.2 配置 SSL 证书
- [ ] 5.3.3 测试域名访问
- [ ] 5.3.4 更新 DNS 记录

### 5.4 生产环境验证
- [ ] 5.4.1 测试生产环境登录
- [ ] 5.4.2 测试生产环境注册
- [ ] 5.4.3 测试生产环境跨系统跳转
- [ ] 5.4.4 测试生产环境所有功能
- [ ] 5.4.5 监控错误日志
- [ ] 5.4.6 检查性能指标

---

## 阶段 6: 文档和培训

### 6.1 更新文档
- [ ] 6.1.1 更新 README.md
- [ ] 6.1.2 更新部署文档
- [ ] 6.1.3 创建用户使用指南
- [ ] 6.1.4 创建管理员操作手册

### 6.2 团队培训
- [ ] 6.2.1 培训内容管理员使用 blog 后台
- [ ] 6.2.2 说明跨系统导航逻辑
- [ ] 6.2.3 演示常见操作流程

---

## 阶段 7: 监控和优化

### 7.1 监控设置
- [ ] 7.1.1 设置错误监控
- [ ] 7.1.2 设置性能监控
- [ ] 7.1.3 设置用户行为分析
- [ ] 7.1.4 配置告警规则

### 7.2 性能优化
- [ ] 7.2.1 优化数据库查询
- [ ] 7.2.2 添加缓存策略
- [ ] 7.2.3 优化图片加载
- [ ] 7.2.4 优化首屏渲染

### 7.3 用户反馈
- [ ] 7.3.1 收集用户反馈
- [ ] 7.3.2 修复发现的问题
- [ ] 7.3.3 优化用户体验
- [ ] 7.3.4 迭代改进

---

## 关键检查点

### ✅ 阶段 1 完成标准
- 所有 blog 表成功创建
- RLS 策略全部生效
- Storage bucket 配置完成
- 可以插入和查询测试数据
- 自动创建 profile 的触发器工作正常

### ✅ 阶段 2 完成标准
- 环境变量配置正确
- blog-system 可以连接到 family-points-bank 数据库
- 无连接错误

### ✅ 阶段 3 完成标准
- 统一认证页面完成
- 旧页面正确重定向
- Middleware 简化完成
- 所有 OAuth 代码已移除
- 组件更新完成

### ✅ 阶段 4 完成标准
- 登录和注册测试通过
- 登录失败自动注册功能正常
- 跨系统用户同步正常
- 无 OAuth 相关功能残留
- 无明显 bug

### ✅ 阶段 5 完成标准
- 生产环境部署成功
- 域名配置完成
- 生产环境功能正常

---

## 风险和应对

### 风险 1: 数据库迁移失败
**应对**: 
- 提前备份数据库
- 准备回滚 SQL
- 在测试环境先执行

### 风险 2: RLS 策略冲突
**应对**:
- 使用唯一的策略名称
- 先删除旧策略再创建
- 逐个测试策略

### 风险 3: Session 共享问题
**应对**:
- 确保使用相同的 Supabase 实例
- 测试跨域 cookie
- 检查 CORS 配置

### 风险 4: 性能下降
**应对**:
- 添加适当的索引
- 监控查询性能
- 优化慢查询

### 风险 5: 自动注册逻辑问题
**应对**:
- 充分测试登录失败场景
- 确保错误提示清晰
- 提供忘记密码功能

---

## 时间估算

- **阶段 1**: 2-3 小时（数据库迁移）
- **阶段 2**: 1 小时（环境配置）
- **阶段 3**: 2-3 小时（代码更新，部分已完成）
- **阶段 4**: 3-4 小时（测试）
- **阶段 5**: 2-3 小时（部署）
- **阶段 6**: 2 小时（文档）
- **阶段 7**: 持续进行（监控优化）

**总计**: 约 1.5-2 个工作日

---

## 已完成工作

### ✅ 统一认证页面
- 创建了 `src/app/auth/page.tsx`
- 实现了登录失败自动注册逻辑
- 实现了魔法链接和忘记密码功能
- 使用了 family-points-bank 的设计风格

### ✅ 旧页面重定向
- 更新了 `src/app/auth/login/page.tsx`
- 更新了 `src/app/auth/signup/page.tsx`

---

## 下一步行动

1. **立即执行**: 数据库迁移（阶段 1）
2. **然后**: 更新环境变量（阶段 2）
3. **接着**: 完成代码更新（阶段 3）
4. **最后**: 测试和部署（阶段 4-5）

---

## 联系人

- **数据库管理**: [负责人]
- **前端开发**: [负责人]
- **测试**: [负责人]
- **运维**: [负责人]

---

## 备注

- 所有操作前请先在测试环境验证
- 保持与团队的沟通
- 及时记录遇到的问题和解决方案
- 完成后更新此文档的状态
- 统一认证页面已按照 family-points-bank 的 AuthGate 组件实现
