# ç³»ç»Ÿè®¾ç½®åŠŸèƒ½ - å®Œæ•´å®ç°æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿè®¾ç½®é¡µé¢æä¾›äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### 1. è´¦æˆ·ä¸å®‰å…¨
- **æ³¨é”€è´¦æˆ·** - æ°¸ä¹…åˆ é™¤å®¶åº­æ‰€æœ‰æ•°æ®ï¼ˆéœ€äºŒæ¬¡ç¡®è®¤ï¼‰

### 2. å¤–è§‚è®¾ç½®
- **è¯­è¨€åˆ‡æ¢** - ä¸­æ–‡/è‹±æ–‡åˆ‡æ¢
- **ä¸»é¢˜åˆ‡æ¢** - æ—¥é—´/å¤œé—´æ¨¡å¼

### 3. æ•°æ®ç®¡ç†
- **å¯¼å‡ºæ•°æ®** - å¯¼å‡ºå®¶åº­æ•°æ®ä¸º JSON
- **æ¸…é™¤ç¼“å­˜** - æ¸…ç†æœ¬åœ°ç¼“å­˜æ•°æ®

### 4. ç³»ç»Ÿä¿¡æ¯
- **å®¶åº­ ID** - æ˜¾ç¤ºå¹¶å¯å¤åˆ¶å½“å‰å®¶åº­åŒæ­¥ ID
- **åº”ç”¨ç‰ˆæœ¬** - æ˜¾ç¤ºå½“å‰åº”ç”¨ç‰ˆæœ¬å·

---

## ğŸ” æ³¨é”€è´¦æˆ·åŠŸèƒ½è¯¦è§£

### åŠŸèƒ½ç‰¹ç‚¹
1. **æ‰€æœ‰å®¶åº­éƒ½å¯ä½¿ç”¨** - ä¸é™åˆ¶ç‰¹å®šå®¶åº­ ID
2. **äºŒæ¬¡ç¡®è®¤æœºåˆ¶** - é˜²æ­¢è¯¯æ“ä½œ
3. **å®Œæ•´æ•°æ®åˆ é™¤** - åˆ é™¤è¯¥å®¶åº­çš„æ‰€æœ‰ç›¸å…³æ•°æ®
4. **æƒé™éªŒè¯** - ä»…ç®¡ç†å‘˜å¯æ‰§è¡Œ

### åˆ é™¤çš„æ•°æ®èŒƒå›´
æ³¨é”€è´¦æˆ·æ—¶ï¼Œå°†åˆ é™¤ä»¥ä¸‹æ‰€æœ‰æ•°æ®ï¼š

| æ•°æ®ç±»å‹ | è¯´æ˜ |
|---------|------|
| **profiles** | æ‰€æœ‰å®¶åº­æˆå‘˜èµ„æ–™ |
| **transactions** | æ‰€æœ‰äº¤æ˜“è®°å½• |
| **tasks** | æ‰€æœ‰ä»»åŠ¡é…ç½® |
| **rewards** | æ‰€æœ‰å¥–åŠ±é…ç½® |
| **messages** | æ‰€æœ‰èŠå¤©æ¶ˆæ¯ |
| **feedback** | æ‰€æœ‰åé¦ˆè®°å½• |
| **badge_progress** | æ‰€æœ‰å¾½ç« è¿›åº¦ |
| **families** | å®¶åº­è®°å½•æœ¬èº« |

### å®‰å…¨æœºåˆ¶
```typescript
// 1. æƒé™éªŒè¯
- åªèƒ½åˆ é™¤è‡ªå·±å®¶åº­çš„æ•°æ®
- å¿…é¡»æ˜¯ç®¡ç†å‘˜è§’è‰²

// 2. äºŒæ¬¡ç¡®è®¤
- æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
- æ˜ç¡®å‘ŠçŸ¥æ•°æ®æ— æ³•æ¢å¤
- éœ€è¦ç”¨æˆ·ä¸»åŠ¨ç¡®è®¤

// 3. å®Œæ•´æ¸…ç†
- åˆ é™¤æ•°æ®åº“è®°å½•
- æ³¨é”€ç™»å½•çŠ¶æ€
- æ¸…é™¤æœ¬åœ°ç¼“å­˜
- è·³è½¬åˆ°ç™»å½•é¡µ
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### å‰ç«¯ç»„ä»¶
```
family-points-bank/components/
â”œâ”€â”€ SystemSettings.tsx          # ç³»ç»Ÿè®¾ç½®ä¸»ç»„ä»¶
â”œâ”€â”€ SettingsSection.tsx         # è®¾ç½®é¡µé¢å®¹å™¨ï¼ˆéœ€æ·»åŠ  system æ ‡ç­¾é¡µï¼‰
â””â”€â”€ ConfirmDialog.tsx           # ç¡®è®¤å¯¹è¯æ¡†ç»„ä»¶
```

### æ•°æ®åº“è¿ç§»
```
family-points-bank/supabase/migrations/
â”œâ”€â”€ 010_add_feedback_system.sql        # åé¦ˆç³»ç»Ÿï¼ˆå¯é€‰ï¼‰
â””â”€â”€ 011_add_delete_family_function.sql # åˆ é™¤å®¶åº­æ•°æ®å‡½æ•° â­
```

---

## ğŸ”§ æ•°æ®åº“å‡½æ•°

### 1. delete_family_data(target_family_id UUID)

**åŠŸèƒ½**ï¼šåˆ é™¤æŒ‡å®šå®¶åº­çš„æ‰€æœ‰æ•°æ®

**å‚æ•°**ï¼š
- `target_family_id` - è¦åˆ é™¤çš„å®¶åº­ ID

**è¿”å›å€¼**ï¼š
```json
{
  "success": true,
  "family_id": "uuid",
  "deleted": {
    "profiles": 5,
    "transactions": 120,
    "tasks": 15,
    "rewards": 10,
    "messages": 50,
    "feedback": 2,
    "badges": 8
  },
  "message": "Family data deleted successfully"
}
```

**æƒé™è¦æ±‚**ï¼š
- å½“å‰ç”¨æˆ·å¿…é¡»å±äºè¯¥å®¶åº­
- å½“å‰ç”¨æˆ·å¿…é¡»æ˜¯ç®¡ç†å‘˜è§’è‰²

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```sql
-- åˆ é™¤å®¶åº­æ•°æ®
SELECT delete_family_data('your-family-id-here');
```

### 2. get_family_data_stats(target_family_id UUID)

**åŠŸèƒ½**ï¼šæŸ¥çœ‹å®¶åº­æ•°æ®ç»Ÿè®¡ï¼ˆåˆ é™¤å‰é¢„è§ˆï¼‰

**è¿”å›å€¼**ï¼š
```json
{
  "family_id": "uuid",
  "profiles_count": 5,
  "transactions_count": 120,
  "tasks_count": 15,
  "rewards_count": 10,
  "messages_count": 50,
  "feedback_count": 2,
  "badges_count": 8
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```sql
-- æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
SELECT get_family_data_stats('your-family-id-here');
```

---

## ğŸš€ é›†æˆæ­¥éª¤

### æ­¥éª¤ 1ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- æ‰§è¡Œè¿ç§»æ–‡ä»¶
\i family-points-bank/supabase/migrations/011_add_delete_family_function.sql
```

æˆ–è€…ç›´æ¥å¤åˆ¶ SQL å†…å®¹åˆ° Supabase Dashboard æ‰§è¡Œã€‚

### æ­¥éª¤ 2ï¼šæ›´æ–° SettingsSection ç»„ä»¶

åœ¨ `SettingsSection.tsx` ä¸­æ·»åŠ  "system" æ ‡ç­¾é¡µï¼š

```typescript
// 1. æ›´æ–° activeTab ç±»å‹
const [activeTab, setActiveTab] = useState<"members" | "tasks" | "rewards" | "system">("members");

// 2. æ·»åŠ ç³»ç»Ÿæ ‡ç­¾åˆ° settingsTabs
const settingsTabs = [
  { id: "members", label: t.settings.members, icon: "ğŸ‘¥" },
  { id: "tasks", label: t.settings.tasks, icon: "ğŸ“‹" },
  { id: "rewards", label: t.settings.rewards, icon: "ğŸ" },
  { id: "system", label: "ç³»ç»Ÿ", icon: "âš™ï¸" }, // æ–°å¢
];

// 3. æ·»åŠ ç³»ç»Ÿè®¾ç½®æ¸²æŸ“
{activeTab === "system" && (
  <SystemSettings
    currentSyncId={currentSyncId}
    language={language}
    onLanguageChange={(lang) => {/* å®ç°è¯­è¨€åˆ‡æ¢ */}}
    onLogout={() => {/* å®ç°ç™»å‡ºé€»è¾‘ */}}
    onExportData={() => {/* å®ç°æ•°æ®å¯¼å‡º */}}
    appVersion="1.0.0"
  />
)}
```

### æ­¥éª¤ 3ï¼šæ·»åŠ ç¿»è¯‘é”®

åœ¨ `i18n/translations.ts` ä¸­æ·»åŠ ï¼š

```typescript
settings: {
  // ... ç°æœ‰ç¿»è¯‘
  system: 'ç³»ç»Ÿè®¾ç½®', // ä¸­æ–‡
  // system: 'System', // è‹±æ–‡
}
```

---

## ğŸ¨ UI è®¾è®¡

### æ³¨é”€è´¦æˆ·æŒ‰é’®æ ·å¼
```tsx
<button className="bg-rose-50 border-rose-100 hover:bg-rose-100">
  <Icon name="trash" /> æ³¨é”€è´¦æˆ·
</button>
```

### ç¡®è®¤å¯¹è¯æ¡†
```
âš ï¸ ç¡®è®¤æ³¨é”€è´¦æˆ·ï¼Ÿ

æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥å®¶åº­çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- æ‰€æœ‰æˆå‘˜èµ„æ–™
- æ‰€æœ‰ä»»åŠ¡å’Œå¥–åŠ±é…ç½®
- æ‰€æœ‰äº¤æ˜“è®°å½•
- æ‰€æœ‰èŠå¤©æ¶ˆæ¯

æ­¤æ“ä½œæ— æ³•æ¢å¤ï¼

[å–æ¶ˆ]  [ç¡®è®¤åˆ é™¤]
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®å®‰å…¨
- âœ… åˆ é™¤å‰å¿…é¡»äºŒæ¬¡ç¡®è®¤
- âœ… ä»…ç®¡ç†å‘˜å¯æ‰§è¡Œ
- âœ… åªèƒ½åˆ é™¤è‡ªå·±å®¶åº­çš„æ•°æ®
- âœ… ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿å®Œæ•´æ€§

### 2. ç”¨æˆ·ä½“éªŒ
- âœ… æ¸…æ™°çš„è­¦å‘Šä¿¡æ¯
- âœ… æ˜¾ç¤ºåˆ é™¤è¿›åº¦
- âœ… åˆ é™¤åè‡ªåŠ¨ç™»å‡º
- âœ… æ¸…é™¤æœ¬åœ°ç¼“å­˜

### 3. é”™è¯¯å¤„ç†
```typescript
try {
  await supabase.rpc('delete_family_data', { target_family_id });
  // æˆåŠŸå¤„ç†
} catch (error) {
  // é”™è¯¯æç¤º
  showToast({ type: 'error', title: 'Delete failed' });
}
```

### 4. æµ‹è¯•å»ºè®®
1. åœ¨æµ‹è¯•ç¯å¢ƒå…ˆæµ‹è¯•
2. ç¡®è®¤æƒé™éªŒè¯æ­£å¸¸
3. éªŒè¯æ•°æ®å®Œå…¨åˆ é™¤
4. æ£€æŸ¥çº§è”åˆ é™¤æ˜¯å¦æ­£ç¡®

---

## ğŸ“Š ä½¿ç”¨æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"æ³¨é”€è´¦æˆ·"
    â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    â†“
ç”¨æˆ·ç¡®è®¤ â† [å–æ¶ˆ] â†’ å…³é—­å¯¹è¯æ¡†
    â†“
éªŒè¯æƒé™ï¼ˆç®¡ç†å‘˜ï¼‰
    â†“
è°ƒç”¨ delete_family_data()
    â†“
åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
    â†“
æ³¨é”€ç™»å½•
    â†“
æ¸…é™¤æœ¬åœ°ç¼“å­˜
    â†“
è·³è½¬åˆ°ç™»å½•é¡µ
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šåˆ é™¤å¤±è´¥ - "Only admin can delete"
**åŸå› **ï¼šå½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜
**è§£å†³**ï¼šç¡®ä¿ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·æ“ä½œ

### é—®é¢˜ 2ï¼šåˆ é™¤å¤±è´¥ - "You can only delete your own family data"
**åŸå› **ï¼šå°è¯•åˆ é™¤å…¶ä»–å®¶åº­çš„æ•°æ®
**è§£å†³**ï¼šåªèƒ½åˆ é™¤è‡ªå·±æ‰€å±å®¶åº­çš„æ•°æ®

### é—®é¢˜ 3ï¼šéƒ¨åˆ†æ•°æ®æœªåˆ é™¤
**åŸå› **ï¼šæ•°æ®åº“å¤–é”®çº¦æŸé—®é¢˜
**è§£å†³**ï¼šæ£€æŸ¥ `ON DELETE CASCADE` è®¾ç½®

### é—®é¢˜ 4ï¼šåˆ é™¤åä»èƒ½çœ‹åˆ°æ•°æ®
**åŸå› **ï¼šç¼“å­˜æœªæ¸…é™¤
**è§£å†³**ï¼šç¡®ä¿è°ƒç”¨ `localStorage.clear()`

---

## ğŸ“ SQL è¿ç§»æ–‡ä»¶

å®Œæ•´çš„ SQL æ–‡ä»¶ä½äºï¼š
```
family-points-bank/supabase/migrations/011_add_delete_family_function.sql
```

åŒ…å«ï¼š
- âœ… `delete_family_data()` å‡½æ•°
- âœ… `get_family_data_stats()` å‡½æ•°
- âœ… å®Œæ•´çš„æƒé™éªŒè¯
- âœ… é”™è¯¯å¤„ç†
- âœ… ä½¿ç”¨ç¤ºä¾‹

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] æ›´æ–° SettingsSection ç»„ä»¶
- [ ] æ·»åŠ  SystemSettings ç»„ä»¶
- [ ] æ·»åŠ ç¿»è¯‘é”®
- [ ] æµ‹è¯•æ³¨é”€åŠŸèƒ½
- [ ] æµ‹è¯•æƒé™éªŒè¯
- [ ] æµ‹è¯•æ•°æ®å®Œæ•´åˆ é™¤
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†

---

## ğŸ‰ æ€»ç»“

ç³»ç»Ÿè®¾ç½®åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ³¨é”€è´¦æˆ·ï¼ˆäºŒæ¬¡ç¡®è®¤ + å®Œæ•´åˆ é™¤ï¼‰
- âœ… è¯­è¨€åˆ‡æ¢
- âœ… ä¸»é¢˜åˆ‡æ¢
- âœ… æ•°æ®å¯¼å‡º
- âœ… æ¸…é™¤ç¼“å­˜
- âœ… ç³»ç»Ÿä¿¡æ¯å±•ç¤º

æ‰€æœ‰åŠŸèƒ½éƒ½å·²å®ç°å›½é™…åŒ–æ”¯æŒï¼ˆä¸­è‹±æ–‡ï¼‰ã€‚
