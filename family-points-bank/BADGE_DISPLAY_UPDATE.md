# 徽章显示功能更新

## 更新内容

### 1. 新增数据库函数
创建了 `get_all_badges_progress` 函数，用于获取所有徽章及其进度信息。

**文件**: `supabase/migrations/008_add_get_all_badges_progress.sql`

**功能**:
- 返回所有徽章定义（包括已获得和未获得的）
- 计算每个徽章的当前进度
- 标记徽章是否已获得
- 返回获得时间（如果已获得）

### 2. 更新前端组件
优化了 `BadgeSection` 组件的显示逻辑。

**主要改进**:

#### "全部徽章"标签页
- 显示所有徽章（已获得 + 未获得）
- 已获得的徽章：
  - 显示在上方
  - 使用彩色图标
  - 显示获得时间
- 未获得的徽章：
  - 显示在下方
  - 使用灰色图标（grayscale 滤镜）
  - 显示"还需 X"的提示
  - 显示进度条和百分比

#### "可领取"标签页
- 只显示已达成条件但未领取的徽章
- 绿色边框和渐变背景
- 右上角有绿色勾选标记（带动画）
- "✨ 可以领取了！"的提示

### 3. 视觉设计

#### 未获得徽章卡片
```
┌─────────────────────────────┐
│  [灰色图标]                  │
│  徽章标题                    │
│  徽章描述                    │
│  ┌───────────────────────┐  │
│  │ 还需 5                 │  │
│  └───────────────────────┘  │
│  ▓▓▓▓▓░░░░░ 50%            │
│  5 / 10                     │
└─────────────────────────────┘
```

#### 可领取徽章卡片
```
┌─────────────────────────────┐ ✓
│  [彩色图标]                  │
│  徽章标题                    │
│  徽章描述                    │
│  ┌───────────────────────┐  │
│  │ ✨ 可以领取了！        │  │
│  └───────────────────────┘  │
└─────────────────────────────┘
```

## 部署步骤

### 1. 执行数据库迁移
在 Supabase Dashboard 的 SQL Editor 中执行：

```bash
# 打开 SQL Editor
# 粘贴 supabase/migrations/008_add_get_all_badges_progress.sql 的内容
# 点击 Run 执行
```

### 2. 验证函数创建
```sql
-- 验证函数是否创建成功
SELECT routine_name, routine_type
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name = 'get_all_badges_progress';

-- 测试函数（替换为实际的 profile_id）
SELECT * FROM get_all_badges_progress('your-profile-uuid-here');
```

### 3. 重新部署前端
```bash
# 清除缓存
rm -rf dist/
rm -rf .next/

# 重新构建
npm run build

# 或者直接启动开发服务器测试
npm run dev
```

## 功能特性

### 进度计算
- **连续天数**: 计算连续完成任务的天数
- **任务数量**: 统计完成的任务总数
- **积分总数**: 累计获得的元气值

### 徽章类型
- **连续徽章** (streak): 基于连续天数
- **里程碑徽章** (milestone): 基于积分总数
- **成就徽章** (achievement): 基于任务数量

### 用户体验
- 清晰的视觉区分（已获得 vs 未获得）
- 实时进度显示
- 一键领取功能
- 响应式设计（移动端友好）

## 注意事项

1. **兼容性**: 代码包含回退逻辑，如果新函数不存在会自动使用旧方法
2. **性能**: 新函数一次性返回所有数据，减少了数据库查询次数
3. **缓存**: 建议清除浏览器缓存以查看最新效果

## 已知徽章列表

根据数据库数据，当前系统包含以下徽章：

### 连续徽章
- 🔥 三日坚持 (streak_3): 连续3天完成任务
- 🔥 七日坚持 (streak_7): 连续7天完成任务

### 成就徽章
- 🎯 初出茅庐 (tasks_10): 完成10个任务
- 🌟 勤奋之星 (tasks_50): 完成50个任务

### 里程碑徽章
- ⭐ 初露锋芒 (total_50): 累计获得50元气值
- 💯 百分成就 (total_100): 累计获得100元气值
- ⭐ 元气大师 (total_500): 累计获得500元气值
- 👑 元气传奇 (total_1000): 累计获得1000元气值

---

**更新时间**: 2026-02-09
**版本**: v1.0
