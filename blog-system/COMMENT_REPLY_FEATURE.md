# 评论回复功能

## 功能说明

已为博客系统添加评论回复功能，用户可以对评论进行回复。

## 数据库变更

### 迁移脚本
运行 `blog-system/supabase/migration-add-comment-replies.sql` 以添加必要的字段：

```sql
-- 添加 parent_id 字段用于评论回复
ALTER TABLE comments 
ADD COLUMN IF NOT EXISTS parent_id UUID REFERENCES comments(id) ON DELETE CASCADE;

-- 添加索引提高查询性能
CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);
```

### 字段说明
- `parent_id`: 父评论ID
  - 如果为 `NULL`，表示这是顶级评论
  - 如果有值，表示这是对某条评论的回复

## 功能特性

### 1. 回复按钮
- 每条顶级评论下方显示"回复"按钮
- 点击后会在评论表单上方显示回复提示
- 回复的评论不显示回复按钮（限制为一层回复）

### 2. 回复提示
- 显示正在回复谁的评论
- 可以取消回复，返回到普通评论模式

### 3. 树形结构显示
- 顶级评论正常显示
- 回复评论会缩进显示（左侧 margin）
- 回复评论显示在父评论下方

### 4. 评论计数
- 统计包括顶级评论和所有回复的总数

## 使用方式

### 用户操作流程
1. 浏览文章评论
2. 点击某条评论下的"回复"按钮
3. 在评论框中输入回复内容
4. 点击"发表回复"提交
5. 回复会显示在原评论下方（缩进显示）

### 取消回复
- 点击回复提示框中的"取消"按钮
- 或者直接提交评论后自动取消回复状态

## 技术实现

### 数据结构
```typescript
interface Comment {
  id: string
  content: string
  created_at: string
  author_name: string
  author_email: string
  parent_id: string | null  // 新增字段
  profiles?: {
    name?: string
    avatar_url?: string
  }
  replies?: Comment[]  // 前端组织的回复列表
}
```

### 查询逻辑
1. 从数据库获取所有评论（包括顶级和回复）
2. 在前端组织为树形结构
3. 使用 Map 建立父子关系
4. 递归渲染评论和回复

### 样式设计
- 回复评论左侧缩进 48px (`ml-12`)
- 回复按钮使用紫色主题色
- 回复提示框使用紫色背景

## 限制说明

### 回复深度
- 当前限制为一层回复（只能回复顶级评论）
- 回复的评论不显示回复按钮
- 这样可以保持评论结构简单清晰

### 为什么限制一层？
1. **用户体验**：多层嵌套会导致阅读困难
2. **界面设计**：深层嵌套在移动端显示不佳
3. **简单明了**：一层回复足够满足大多数讨论需求

## 未来扩展

如果需要支持多层回复，可以：
1. 移除回复按钮的 `!isReply` 条件
2. 调整缩进样式（使用 `depth * 48px`）
3. 考虑添加"查看更多回复"折叠功能
4. 在移动端使用不同的显示方式

## 测试建议

1. 测试顶级评论发表
2. 测试回复功能
3. 测试取消回复
4. 测试多条回复的显示
5. 测试审核状态（非管理员的回复需要审核）
6. 测试移动端显示效果
